<template>
  <div class="calendar-page">
    <!-- ÁÇ´ÈÖ∑ÁöÑÂ§¥ÈÉ® -->
    <div class="calendar-header">
      <div class="header-content">
        <div class="header-left">
          <h1 class="header-title">üìÖ Êô∫ËÉΩÊó•Á®ãÁÆ°ÁêÜ</h1>
          <p class="header-subtitle">ÂèØËßÜÂåñÊÇ®ÁöÑÊØè‰∏ÄÂ§©ÔºåËÆ©Êó∂Èó¥Êõ¥Êúâ‰ª∑ÂÄº</p>
        </div>
        <div class="header-actions">
          <el-button type="primary" size="large" @click="showQuickAddDialog = true">
            <el-icon><Plus /></el-icon>
            Âø´ÈÄüÊ∑ªÂä†
          </el-button>
          <el-button size="large" @click="goToTodos">
            <el-icon><List /></el-icon>
            ‰ªªÂä°ÂàóË°®
          </el-button>
        </div>
      </div>
    </div>

    <!-- Â§ßÊó•ÂéÜ‰∏ª‰Ωì -->
    <div class="calendar-main">
      <!-- Êó•ÂéÜÂØºËà™Ê†è -->
      <div class="calendar-nav">
        <div class="nav-left">
          <el-button-group>
            <el-button @click="prevMonth" :icon="ArrowLeft" />
            <el-button @click="nextMonth" :icon="ArrowRight" />
          </el-button-group>
          <el-button @click="goToToday" type="primary" plain>‰ªäÂ§©</el-button>
        </div>

        <div class="nav-center">
          <h2 class="current-month">{{ currentMonthYear }}</h2>
        </div>

                 <div class="nav-right">
           <el-select v-model="viewMode" size="large" style="width: 120px">
             <el-option label="ÊúàËßÜÂõæ" value="month" />
             <el-option label="Âë®ËßÜÂõæ" value="week" />
             <el-option label="Êó•ËßÜÂõæ" value="day" />
           </el-select>
         </div>
      </div>

             <!-- ÊúàËßÜÂõæ -->
       <div v-if="viewMode === 'month'" class="calendar-grid">
         <!-- ÊòüÊúüÊ†áÈ¢ò -->
         <div class="calendar-weekdays">
           <div
             v-for="day in weekdays"
             :key="day"
             class="weekday-header"
             :class="{ 'weekend': day === 'Âë®ÂÖ≠' || day === 'Âë®Êó•' }"
           >
             {{ day }}
           </div>
         </div>

         <!-- Êó•ÊúüÁΩëÊ†º -->
         <div class="calendar-days">
           <div
             v-for="day in calendarDays"
             :key="day.date"
             class="calendar-day"
             :class="[
               { 'other-month': !day.isCurrentMonth },
               { 'today': day.isToday },
               { 'selected': day.isSelected },
               { 'weekend': day.isWeekend },
               { 'has-events': day.events.length > 0 }
             ]"
             @click="handleDateClick(day)"
             @dblclick="handleDateDoubleClick(day)"
           >
             <!-- Êó•ÊúüÊï∞Â≠ó -->
             <div class="day-number">
               <span class="date-number">{{ day.dayNumber }}</span>
               <span v-if="day.lunarDate" class="lunar-date">{{ day.lunarDate }}</span>
             </div>

             <!-- ‰∫ã‰ª∂ÂàóË°® -->
             <div class="day-events">
               <div
                 v-for="(event, index) in day.events.slice(0, 3)"
                 :key="event.id"
                 class="day-event"
                 :class="getEventClass(event)"
                 @click.stop="viewEvent(event)"
               >
                 <div class="event-dot"></div>
                 <span class="event-title">{{ event.title }}</span>
                 <!-- Ë∑®Â§©‰ªªÂä°ËøûÊé•ÊåáÁ§∫Âô® -->
                 <div v-if="event.isMultiDay && !event.isLastDay" class="event-continue-indicator">
                   <el-icon><ArrowRight /></el-icon>
                 </div>
               </div>

               <!-- Êõ¥Â§ö‰∫ã‰ª∂ÊåáÁ§∫Âô® -->
               <div
                 v-if="day.events.length > 3"
                 class="more-events"
                 @click.stop="viewAllEvents(day)"
               >
                 +{{ day.events.length - 3 }} Êõ¥Â§ö
               </div>
             </div>

             <!-- Ê∑ªÂä†ÊåâÈíÆ -->
             <div class="day-add-btn" @click.stop="handleAddButtonClick(day)">
               <el-icon><Plus /></el-icon>
             </div>
           </div>
         </div>
       </div>

       <!-- Âë®ËßÜÂõæ -->
       <div v-if="viewMode === 'week'" class="week-view">
         <div class="week-header">
           <div class="week-day-header">Êó∂Èó¥</div>
           <div
             v-for="day in weekDays"
             :key="day.date"
             class="week-day-header"
             :class="{ 'weekend': day.isWeekend, 'today': day.isToday, 'selected': day.isSelected }"
             @click="selectDate(day)"
           >
             <div class="week-day-name">{{ day.dayName }}</div>
             <div class="week-day-number">{{ day.dayNumber }}</div>
           </div>
         </div>

         <div class="week-content">
           <div class="time-column">
             <div v-for="hour in 24" :key="hour" class="time-slot">
               {{ (hour - 1).toString().padStart(2, '0') }}:00
             </div>
           </div>

           <div
             v-for="day in weekDays"
             :key="day.date"
             class="week-day-column"
             :class="{ 'weekend': day.isWeekend, 'today': day.isToday, 'selected': day.isSelected }"
           >
             <div
               v-for="hour in 24"
               :key="hour"
               class="time-slot"
               @click="handleTimeSlotClick(day, hour - 1)"
             >
               <div
                 v-for="event in getEventsForTimeSlot(day, hour - 1)"
                 :key="event.id"
                 class="week-event"
                 :class="getEventClass(event)"
                 @click.stop="viewEvent(event)"
               >
                 {{ event.title }}
                 <!-- Ë∑®Â§©‰ªªÂä°ËøûÊé•ÊåáÁ§∫Âô® -->
                 <div v-if="event.isMultiDay && !event.isLastDay" class="event-continue-indicator">
                   <el-icon><ArrowRight /></el-icon>
                 </div>
               </div>
             </div>
           </div>
         </div>
       </div>

       <!-- Êó•ËßÜÂõæ -->
       <div v-if="viewMode === 'day'" class="day-view">
         <div class="day-header">
           <h3>{{ selectedDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }) }}</h3>
         </div>

         <div class="day-timeline">
           <div
             v-for="timeSlot in dayViewEvents"
             :key="timeSlot.hour"
             class="time-slot"
             :class="{ 'current-hour': timeSlot.hour === new Date().getHours() }"
           >
             <div class="time-label">{{ timeSlot.time }}</div>
             <div class="time-content">
               <div
                 v-for="event in timeSlot.events"
                 :key="event.id"
                 class="day-event"
                 :class="getEventClass(event)"
                 @click="viewEvent(event)"
               >
                 <div class="event-time">{{ formatEventTime(event) }}</div>
                 <div class="event-title">{{ event.title }}</div>
                 <div class="event-description">{{ event.description }}</div>
               </div>

               <!-- Ê∑ªÂä†ÊåâÈíÆ -->
               <div
                 class="add-event-btn"
                 @click="handleTimeSlotClick({ date: selectedDate.toISOString().split('T')[0] }, timeSlot.hour)"
               >
                 <el-icon><Plus /></el-icon>
               </div>
             </div>
           </div>
         </div>
       </div>
    </div>

    <!-- Âø´ÈÄüÊ∑ªÂä†ÂØπËØùÊ°Ü -->
    <el-dialog
      v-model="showQuickAddDialog"
      title="Âø´ÈÄüÊ∑ªÂä†‰ªªÂä°"
      width="600px"
      :close-on-click-modal="false"
    >
      <el-form :model="quickAddForm" label-width="100px">
        <el-form-item label="‰ªªÂä°Ê†áÈ¢ò" required>
          <el-input v-model="quickAddForm.title" placeholder="ËæìÂÖ•‰ªªÂä°Ê†áÈ¢ò" />
        </el-form-item>

                <el-form-item label="ÂÖ®Â§©‰ªªÂä°">
          <el-switch v-model="quickAddForm.isAllDay" />
        </el-form-item>

        <!-- ÂÖ®Â§©‰ªªÂä°ÔºöÂè™ÈúÄË¶Å‰∏Ä‰∏™Êó•Êúü -->
        <el-form-item label="‰ªªÂä°Êó•Êúü" v-if="quickAddForm.isAllDay" required>
          <el-date-picker
            v-model="quickAddForm.startDate"
            type="date"
            placeholder="ÈÄâÊã©‰ªªÂä°Êó•Êúü"
            format="YYYY-MM-DD"
            value-format="YYYY-MM-DD"
          />
        </el-form-item>

        <!-- ÈùûÂÖ®Â§©‰ªªÂä°ÔºöÂºÄÂßãÊó•Êúü+Êó∂Èó¥ÔºåÁªìÊùüÊó•Êúü+Êó∂Èó¥ -->
        <template v-if="!quickAddForm.isAllDay">
          <el-form-item label="ÂºÄÂßãÊó∂Èó¥" required>
            <div class="datetime-group">
              <el-date-picker
                v-model="quickAddForm.startDate"
                type="date"
                placeholder="ÂºÄÂßãÊó•Êúü"
                format="YYYY-MM-DD"
                value-format="YYYY-MM-DD"
                style="width: 60%"
              />
              <el-time-picker
                v-model="quickAddForm.startTime"
                placeholder="ÂºÄÂßãÊó∂Èó¥"
                format="HH:mm"
                value-format="HH:mm"
                :disabled-hours="() => []"
                :disabled-minutes="() => []"
                style="width: 35%"
              />
            </div>
          </el-form-item>

          <el-form-item label="ÁªìÊùüÊó∂Èó¥">
            <div class="datetime-group">
              <el-date-picker
                v-model="quickAddForm.endDate"
                type="date"
                placeholder="ÁªìÊùüÊó•ÊúüÔºàÂèØÈÄâÔºåÈªòËÆ§Âêå‰∏ÄÂ§©Ôºâ"
                format="YYYY-MM-DD"
                value-format="YYYY-MM-DD"
                style="width: 60%"
              />
              <el-time-picker
                v-model="quickAddForm.endTime"
                placeholder="ÁªìÊùüÊó∂Èó¥"
                format="HH:mm"
                value-format="HH:mm"
                :disabled-hours="() => []"
                :disabled-minutes="() => []"
                style="width: 35%"
              />
            </div>
          </el-form-item>

          <el-form-item label="Êó∂Èó¥È¢ÑËÆæ">
            <div class="time-presets">
              <el-button
                v-for="preset in timePresets"
                :key="preset.label"
                size="small"
                @click="setTimePreset(preset)"
                :type="isTimePresetActive(preset) ? 'primary' : 'default'"
              >
                {{ preset.label }}
              </el-button>
            </div>
          </el-form-item>
        </template>

        <el-form-item label="‰ºòÂÖàÁ∫ß">
          <el-select v-model="quickAddForm.priority" placeholder="ÈÄâÊã©‰ºòÂÖàÁ∫ß">
            <el-option label="‰Ωé" value="low" />
            <el-option label="‰∏≠" value="medium" />
            <el-option label="È´ò" value="high" />
            <el-option label="Á¥ßÊÄ•" value="urgent" />
          </el-select>
        </el-form-item>

        <el-form-item label="ÂàÜÁ±ª">
          <hover-category-selector
            v-model="quickAddForm.category_id"
            :categories="todoStore.categories"
            placeholder="ÈÄâÊã©ÂàÜÁ±ª"
          />
        </el-form-item>

        <el-form-item label="ÊèèËø∞">
          <el-input
            v-model="quickAddForm.description"
            type="textarea"
            :rows="3"
            placeholder="‰ªªÂä°ÊèèËø∞ÔºàÂèØÈÄâÔºâ"
          />
        </el-form-item>
      </el-form>

      <template #footer>
        <span class="dialog-footer">
          <el-button @click="showQuickAddDialog = false">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="addQuickTask">Ê∑ªÂä†‰ªªÂä°</el-button>
        </span>
      </template>
    </el-dialog>

    <!-- ‰∫ã‰ª∂ËØ¶ÊÉÖÂØπËØùÊ°Ü -->
    <el-dialog
      v-model="showEventDialog"
      title="‰ªªÂä°ËØ¶ÊÉÖ"
      width="700px"
    >
      <div v-if="selectedEvent" class="event-detail">
        <!-- ‰ªªÂä°Ê†áÈ¢ò -->
        <div class="event-header">
          <h3>{{ selectedEvent.title }}</h3>
          <div class="event-actions">
            <el-button size="small" type="primary" @click="editEvent(selectedEvent)">
              ÁºñËæë
            </el-button>
            <el-button size="small" type="danger" @click="deleteEvent(selectedEvent)">
              Âà†Èô§
            </el-button>
          </div>
        </div>

        <!-- ‰ªªÂä°ÊèèËø∞ -->
        <div v-if="selectedEvent.description" class="event-section">
          <h4>‰ªªÂä°ÊèèËø∞</h4>
          <p class="event-description">{{ selectedEvent.description }}</p>
        </div>

        <!-- ‰ªªÂä°Áä∂ÊÄÅÂíå‰ºòÂÖàÁ∫ß -->
        <div class="event-section">
          <h4>‰ªªÂä°‰ø°ÊÅØ</h4>
          <div class="event-meta">
            <div class="meta-item">
              <span class="meta-label">Áä∂ÊÄÅ:</span>
              <el-tag :type="getStatusType(selectedEvent.status)" size="small">
                {{ getStatusText(selectedEvent.status) }}
              </el-tag>
            </div>
            <div class="meta-item">
              <span class="meta-label">‰ºòÂÖàÁ∫ß:</span>
              <el-tag :type="getPriorityType(selectedEvent.priority)" size="small">
                {{ getPriorityText(selectedEvent.priority) }}
              </el-tag>
            </div>
          </div>
        </div>

        <!-- Êó∂Èó¥‰ø°ÊÅØ -->
        <div class="event-section">
          <h4>Êó∂Èó¥‰ø°ÊÅØ</h4>
          <div class="time-info">
            <div class="time-item">
              <span class="time-label">ÂºÄÂßãÊó∂Èó¥:</span>
              <span class="time-value">{{ formatEventDateTime(selectedEvent.start_date || selectedEvent.startDate) }}</span>
            </div>
            <div class="time-item">
              <span class="time-label">Êà™Ê≠¢Êó∂Èó¥:</span>
              <span class="time-value" :class="{ 'overdue': isOverdue(selectedEvent) }">
                {{ formatEventDateTime(selectedEvent.due_date || selectedEvent.dueDate) }}
              </span>
            </div>
            <div v-if="selectedEvent.completed_at || selectedEvent.completedAt" class="time-item">
              <span class="time-label">ÂÆåÊàêÊó∂Èó¥:</span>
              <span class="time-value">{{ formatEventDateTime(selectedEvent.completed_at || selectedEvent.completedAt) }}</span>
            </div>
            <div v-if="selectedEvent.estimated_hours || selectedEvent.estimatedHours" class="time-item">
              <span class="time-label">È¢Ñ‰º∞Â∑•Êó∂:</span>
              <span class="time-value">{{ selectedEvent.estimated_hours || selectedEvent.estimatedHours }} Â∞èÊó∂</span>
            </div>
            <div v-if="selectedEvent.actual_hours || selectedEvent.actualHours" class="time-item">
              <span class="time-label">ÂÆûÈôÖÂ∑•Êó∂:</span>
              <span class="time-value">{{ selectedEvent.actual_hours || selectedEvent.actualHours }} Â∞èÊó∂</span>
            </div>
          </div>
        </div>

        <!-- Ë∑®Â§©‰ø°ÊÅØ -->
        <div v-if="isMultiDayEvent(selectedEvent)" class="event-section">
          <h4>Ë∑®Â§©‰ø°ÊÅØ</h4>
          <div class="multiday-info">
            <el-icon><Calendar /></el-icon>
            <span>ËøôÊòØ‰∏Ä‰∏™Ë∑®Â§©‰ªªÂä°ÔºåÊåÅÁª≠ {{ getEventDuration(selectedEvent) }} Â§©</span>
          </div>
        </div>

        <!-- ÂàõÂª∫‰ø°ÊÅØ -->
        <div class="event-section">
          <h4>ÂàõÂª∫‰ø°ÊÅØ</h4>
          <div class="create-info">
            <div class="info-item">
              <span class="info-label">ÂàõÂª∫Êó∂Èó¥:</span>
              <span class="info-value">{{ formatEventDateTime(selectedEvent.created_at || selectedEvent.createdAt) }}</span>
            </div>
            <div v-if="selectedEvent.updated_at || selectedEvent.updatedAt" class="info-item">
              <span class="info-label">Êõ¥Êñ∞Êó∂Èó¥:</span>
              <span class="info-value">{{ formatEventDateTime(selectedEvent.updated_at || selectedEvent.updatedAt) }}</span>
            </div>
          </div>
        </div>

        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <div class="event-actions-bottom">
          <el-button
            v-if="selectedEvent.status !== 'completed'"
            type="success"
            @click="completeEvent(selectedEvent)"
          >
            Ê†áËÆ∞ÂÆåÊàê
          </el-button>
          <el-button
            v-if="selectedEvent.status === 'pending'"
            type="warning"
            @click="startEvent(selectedEvent)"
          >
            ÂºÄÂßã‰ªªÂä°
          </el-button>
          <el-button
            v-if="selectedEvent.status === 'in_progress'"
            type="info"
            @click="pauseEvent(selectedEvent)"
          >
            ÊöÇÂÅú‰ªªÂä°
          </el-button>
        </div>
      </div>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { useTodoStore } from '@/stores/todo'
import { ElMessage, ElMessageBox } from 'element-plus'
import { Plus, ArrowLeft, ArrowRight, Calendar, List } from '@element-plus/icons-vue'
import HoverCategorySelector from '@/components/common/HoverCategorySelector.vue'

const router = useRouter()
const todoStore = useTodoStore()

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const currentDate = ref(new Date())
const selectedDate = ref(new Date())
const viewMode = ref('month') // 'month', 'week', 'day'
const showQuickAddDialog = ref(false)
const showEventDialog = ref(false)
const selectedEvent = ref(null)

// Âø´ÈÄüÊ∑ªÂä†Ë°®Âçï
// Êó∂Èó¥È¢ÑËÆæ
const timePresets = [
  { label: '‰∏äÂçà', start: '09:00', end: '12:00' },
  { label: '‰∏ãÂçà', start: '14:00', end: '18:00' },
  { label: 'Êôö‰∏ä', start: '19:00', end: '22:00' },
  { label: 'ÂÖ®Â§©', start: '00:00', end: '23:59' },
  { label: '1Â∞èÊó∂', start: '09:00', end: '10:00' },
  { label: '2Â∞èÊó∂', start: '09:00', end: '11:00' },
  { label: '4Â∞èÊó∂', start: '09:00', end: '13:00' }
]

const quickAddForm = ref({
  title: '',
  date: '',
  startTime: '09:00',
  endTime: '10:00',
  isAllDay: false,
  startDate: '',
  endDate: '',
  priority: 'medium',
  description: '',
  category_id: null
})

// ËÆ°ÁÆóÂ±ûÊÄß
const currentMonthYear = computed(() => {
  if (viewMode.value === 'month') {
    return currentDate.value.toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: 'long'
    })
  } else if (viewMode.value === 'week') {
    const startOfWeek = new Date(selectedDate.value)
    startOfWeek.setDate(selectedDate.value.getDate() - selectedDate.value.getDay())
    const endOfWeek = new Date(startOfWeek)
    endOfWeek.setDate(startOfWeek.getDate() + 6)

    return `${startOfWeek.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' })} - ${endOfWeek.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', year: 'numeric' })}`
  } else if (viewMode.value === 'day') {
    return selectedDate.value.toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      weekday: 'long'
    })
  }
  return ''
})

const selectedDateFormatted = computed(() => {
  return selectedDate.value.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    weekday: 'long'
  })
})

const weekdays = ['Âë®Êó•', 'Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠']

// ËæÖÂä©ÂáΩÊï∞ÔºöËé∑ÂèñÊú¨Âú∞Êó•ÊúüÂ≠óÁ¨¶‰∏≤Ôºà‰∏çËÄÉËôëÊó∂Âå∫Ôºâ
const getLocalDateString = (date) => {
  const year = date.getFullYear()
  const month = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')
  return `${year}-${month}-${day}`
}

const calendarDays = computed(() => {
  const year = currentDate.value.getFullYear()
  const month = currentDate.value.getMonth()
  const firstDay = new Date(year, month, 1)
  const startDate = new Date(firstDay)
  startDate.setDate(startDate.getDate() - firstDay.getDay())

  const days = []
  const today = new Date()

  for (let i = 0; i < 42; i++) {
    const date = new Date(startDate)
    date.setDate(startDate.getDate() + i)

    const dayEvents = getEventsForDate(date)
    const isWeekend = date.getDay() === 0 || date.getDay() === 6

    days.push({
      date: getLocalDateString(date),
      dayNumber: date.getDate(),
      lunarDate: getLunarDate(date),
      isCurrentMonth: date.getMonth() === month,
      isToday: getLocalDateString(date) === getLocalDateString(today),
      isSelected: getLocalDateString(date) === getLocalDateString(selectedDate.value),
      isWeekend: isWeekend,
      events: dayEvents
    })
  }

  return days
})

const selectedDateEvents = computed(() => {
  return getEventsForDate(selectedDate.value)
})

// Âë®ËßÜÂõæÊï∞ÊçÆ
const weekDays = computed(() => {
  if (viewMode.value !== 'week') return []

  const startOfWeek = new Date(selectedDate.value)
  startOfWeek.setDate(selectedDate.value.getDate() - selectedDate.value.getDay())

  const days = []
  for (let i = 0; i < 7; i++) {
    const date = new Date(startOfWeek)
    date.setDate(startOfWeek.getDate() + i)

    const dayEvents = getEventsForDate(date)
    const isWeekend = date.getDay() === 0 || date.getDay() === 6

    days.push({
      date: getLocalDateString(date),
      dayNumber: date.getDate(),
      dayName: date.toLocaleDateString('zh-CN', { weekday: 'short' }),
      lunarDate: getLunarDate(date),
      isToday: getLocalDateString(date) === getLocalDateString(new Date()),
      isSelected: getLocalDateString(date) === getLocalDateString(selectedDate.value),
      isWeekend: isWeekend,
      events: dayEvents
    })
  }

  return days
})

// Â§©ËßÜÂõæÊï∞ÊçÆ
const dayViewEvents = computed(() => {
  if (viewMode.value !== 'day') return []

  const events = getEventsForDate(selectedDate.value)
  const timeSlots = []

  // ÁîüÊàê24Â∞èÊó∂Êó∂Èó¥ÊÆµ
  for (let hour = 0; hour < 24; hour++) {
    const timeSlot = {
      hour: hour,
      time: `${hour.toString().padStart(2, '0')}:00`,
      events: []
    }

    // ‰∏∫ÊØè‰∏™Êó∂Èó¥ÊÆµÂàÜÈÖç‰∫ã‰ª∂
    events.forEach(event => {
      const startTime = event.startDate || event.start_date ? new Date(event.startDate || event.start_date).getHours() : 9
      const endTime = event.dueDate || event.due_date ? new Date(event.dueDate || event.due_date).getHours() : 10

      if (hour >= startTime && hour <= endTime) {
        timeSlot.events.push(event)
      }
    })

    timeSlots.push(timeSlot)
  }

  return timeSlots
})

// ÊñπÊ≥ï
const prevMonth = () => {
  if (viewMode.value === 'month') {
    currentDate.value = new Date(currentDate.value.getFullYear(), currentDate.value.getMonth() - 1, 1)
  } else if (viewMode.value === 'week') {
    // ÂàáÊç¢Âà∞‰∏ä‰∏ÄÂë®
    const newDate = new Date(selectedDate.value)
    newDate.setDate(selectedDate.value.getDate() - 7)
    selectedDate.value = newDate
  } else if (viewMode.value === 'day') {
    // ÂàáÊç¢Âà∞‰∏ä‰∏ÄÂ§©
    const newDate = new Date(selectedDate.value)
    newDate.setDate(selectedDate.value.getDate() - 1)
    selectedDate.value = newDate
  }
}

const nextMonth = () => {
  if (viewMode.value === 'month') {
    currentDate.value = new Date(currentDate.value.getFullYear(), currentDate.value.getMonth() + 1, 1)
  } else if (viewMode.value === 'week') {
    // ÂàáÊç¢Âà∞‰∏ã‰∏ÄÂë®
    const newDate = new Date(selectedDate.value)
    newDate.setDate(selectedDate.value.getDate() + 7)
    selectedDate.value = newDate
  } else if (viewMode.value === 'day') {
    // ÂàáÊç¢Âà∞‰∏ã‰∏ÄÂ§©
    const newDate = new Date(selectedDate.value)
    newDate.setDate(selectedDate.value.getDate() + 1)
    selectedDate.value = newDate
  }
}

// ÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜ
let clickTimer = null

const handleDateClick = (day) => {
  // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
  if (clickTimer) {
    clearTimeout(clickTimer)
  }

  // ËÆæÁΩÆÊñ∞ÁöÑÂÆöÊó∂Âô®ÔºåÂª∂ËøüÂ§ÑÁêÜÂçïÂáª‰∫ã‰ª∂
  clickTimer = setTimeout(() => {
    selectDate(day)
  }, 200) // 200msÂª∂ËøüÔºåÈÅøÂÖç‰∏éÂèåÂáªÂÜ≤Á™Å
}

const handleDateDoubleClick = (day) => {
  // Ê∏ÖÈô§ÂçïÂáªÂÆöÊó∂Âô®
  if (clickTimer) {
    clearTimeout(clickTimer)
    clickTimer = null
  }

  // Â§ÑÁêÜÂèåÂáª‰∫ã‰ª∂
  handleAddButtonClick(day)
}

const handleAddButtonClick = (day) => {
  showQuickAddDialog.value = true
  selectedDate.value = new Date(day.date)
  quickAddForm.value.startDate = day.date
  quickAddForm.value.endDate = day.date
  quickAddForm.value.isAllDay = true
  console.log('Ê∑ªÂä†ÊåâÈíÆÁÇπÂáªÔºåÊó•Êúü:', day.date, 'ËÆæÁΩÆÂà∞Ë°®Âçï:', quickAddForm.value.startDate)
}

const selectDate = (day) => {
  // ‰øÆÂ§çÊó•ÊúüÈÄâÊã©ÂÅèÁßªÈóÆÈ¢òÔºåÁõ¥Êé•‰ΩøÁî®‰º†ÂÖ•ÁöÑÊó•ÊúüÂØπË±°
  selectedDate.value = new Date(day.date)
  console.log('ÈÄâÊã©Êó•Êúü:', day.date, 'ÂÆûÈôÖÈÄâÊã©:', selectedDate.value.toISOString().split('T')[0])
}

const goToToday = () => {
  const today = new Date()
  currentDate.value = new Date()
  selectedDate.value = new Date()

  // Ê†πÊçÆËßÜÂõæÊ®°ÂºèË∞ÉÊï¥ÊòæÁ§∫
  if (viewMode.value === 'month') {
    // ÊúàËßÜÂõæÔºöË∑≥ËΩ¨Âà∞ÂΩìÂâçÊúà‰ªΩ
    currentDate.value = new Date(today.getFullYear(), today.getMonth(), 1)
  } else if (viewMode.value === 'week') {
    // Âë®ËßÜÂõæÔºöË∑≥ËΩ¨Âà∞ÂΩìÂâçÂë®
    selectedDate.value = new Date()
  } else if (viewMode.value === 'day') {
    // Êó•ËßÜÂõæÔºöË∑≥ËΩ¨Âà∞‰ªäÂ§©
    selectedDate.value = new Date()
  }
}

const goToTodos = () => {
  router.push('/dashboard/todos')
}

const viewEvent = (event) => {
  selectedEvent.value = event
  showEventDialog.value = true
}

const viewAllEvents = (day) => {
  selectedDate.value = new Date(day.date)
  // ÂèØ‰ª•Ë∑≥ËΩ¨Âà∞ËØ¶ÁªÜËßÜÂõæÊàñÊòæÁ§∫Êõ¥Â§ö‰∫ã‰ª∂
}

const handleTimeSlotClick = (day, hour) => {
  showQuickAddDialog.value = true
  selectedDate.value = new Date(day.date)
  quickAddForm.value.startDate = day.date
  quickAddForm.value.endDate = day.date
  quickAddForm.value.isAllDay = false
  quickAddForm.value.startTime = `${hour.toString().padStart(2, '0')}:00`
  quickAddForm.value.endTime = `${(hour + 1).toString().padStart(2, '0')}:00`
  console.log('Êó∂Èó¥ÊÆµÁÇπÂáªÔºåÊó•Êúü:', day.date, 'Â∞èÊó∂:', hour, 'ËÆæÁΩÆÂà∞Ë°®Âçï:', quickAddForm.value.startDate, 'Êó∂Èó¥:', quickAddForm.value.startTime)
}

// ËÆæÁΩÆÊó∂Èó¥È¢ÑËÆæ
const setTimePreset = (preset) => {
  quickAddForm.value.startTime = preset.start
  quickAddForm.value.endTime = preset.end
}

// Ê£ÄÊü•Êó∂Èó¥È¢ÑËÆæÊòØÂê¶ÊøÄÊ¥ª
const isTimePresetActive = (preset) => {
  return quickAddForm.value.startTime === preset.start && quickAddForm.value.endTime === preset.end
}

// Ê†ºÂºèÂåñ‰∫ã‰ª∂Êó•ÊúüÊó∂Èó¥
const formatEventDateTime = (dateTime) => {
  if (!dateTime) return 'Êú™ËÆæÁΩÆ'
  const date = new Date(dateTime)
  return date.toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  })
}

// Ê£ÄÊü•ÊòØÂê¶Ë∂ÖÊó∂
const isOverdue = (event) => {
  const dueDate = event.due_date || event.dueDate
  if (!dueDate) return false
  return new Date(dueDate) < new Date() && event.status !== 'completed'
}

// Ê£ÄÊü•ÊòØÂê¶‰∏∫Ë∑®Â§©‰∫ã‰ª∂
const isMultiDayEvent = (event) => {
  const startDate = event.start_date || event.startDate
  const dueDate = event.due_date || event.dueDate
  if (!startDate || !dueDate) return false

  const start = new Date(startDate)
  const end = new Date(dueDate)
  const startStr = getLocalDateString(start)
  const endStr = getLocalDateString(end)

  return startStr !== endStr
}

// Ëé∑Âèñ‰∫ã‰ª∂ÊåÅÁª≠Êó∂Èó¥
const getEventDuration = (event) => {
  const startDate = event.start_date || event.startDate
  const dueDate = event.due_date || event.dueDate
  if (!startDate || !dueDate) return 1

  const start = new Date(startDate)
  const end = new Date(dueDate)
  const diffTime = Math.abs(end - start)
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24))

  return diffDays
}

// ‰∫ã‰ª∂Êìç‰ΩúÂáΩÊï∞
const editEvent = (event) => {
  // TODO: ÂÆûÁé∞ÁºñËæëÂäüËÉΩ
  ElMessage.info('ÁºñËæëÂäüËÉΩÂºÄÂèë‰∏≠...')
}

const deleteEvent = async (event) => {
  try {
    await ElMessageBox.confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰ªªÂä°ÂêóÔºü', 'Á°ÆËÆ§Âà†Èô§', {
      confirmButtonText: 'Á°ÆÂÆö',
      cancelButtonText: 'ÂèñÊ∂à',
      type: 'warning'
    })

    const success = await todoStore.deleteTodo(event.id)
    if (success) {
      showEventDialog.value = false
      await todoStore.fetchTodos()
    }
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('Âà†Èô§‰ªªÂä°Â§±Ë¥•')
    }
  }
}

const completeEvent = async (event) => {
  try {
    const success = await todoStore.updateTodo(event.id, { status: 'completed' })
    if (success) {
      showEventDialog.value = false
      await todoStore.fetchTodos()
      ElMessage.success('‰ªªÂä°Â∑≤ÂÆåÊàê')
    }
  } catch (error) {
    ElMessage.error('Êõ¥Êñ∞‰ªªÂä°Áä∂ÊÄÅÂ§±Ë¥•')
  }
}

const startEvent = async (event) => {
  try {
    const success = await todoStore.updateTodo(event.id, { status: 'in_progress' })
    if (success) {
      showEventDialog.value = false
      await todoStore.fetchTodos()
      ElMessage.success('‰ªªÂä°Â∑≤ÂºÄÂßã')
    }
  } catch (error) {
    ElMessage.error('Êõ¥Êñ∞‰ªªÂä°Áä∂ÊÄÅÂ§±Ë¥•')
  }
}

const pauseEvent = async (event) => {
  try {
    const success = await todoStore.updateTodo(event.id, { status: 'pending' })
    if (success) {
      showEventDialog.value = false
      await todoStore.fetchTodos()
      ElMessage.success('‰ªªÂä°Â∑≤ÊöÇÂÅú')
    }
  } catch (error) {
    ElMessage.error('Êõ¥Êñ∞‰ªªÂä°Áä∂ÊÄÅÂ§±Ë¥•')
  }
}

const getEventsForTimeSlot = (day, hour) => {
  const events = getEventsForDate(new Date(day.date))
  return events.filter(event => {
    const startTime = event.startDate || event.start_date ? new Date(event.startDate || event.start_date).getHours() : 9
    const endTime = event.dueDate || event.due_date ? new Date(event.dueDate || event.due_date).getHours() : 10
    return hour >= startTime && hour <= endTime
  })
}

const addQuickTask = async () => {
  if (!quickAddForm.value.title.trim()) {
    ElMessage.warning('ËØ∑ËæìÂÖ•‰ªªÂä°Ê†áÈ¢ò')
    return
  }

  if (!quickAddForm.value.startDate) {
    ElMessage.warning('ËØ∑ÈÄâÊã©ÂºÄÂßãÊó•Êúü')
    return
  }

  try {
    const priorityMap = {
      'low': 1,
      'medium': 2,
      'high': 3,
      'urgent': 4
    }

    // Â§ÑÁêÜÊó•ÊúüÂíåÊó∂Èó¥Ê†ºÂºè
    let startDate = null
    let dueDate = null

        if (quickAddForm.value.isAllDay) {
      // ÂÖ®Â§©‰ªªÂä° - Âè™ÈúÄË¶Å‰∏Ä‰∏™Êó•Êúü
      const [startYear, startMonth, startDay] = quickAddForm.value.startDate.split('-').map(Number)
      const startDateTime = new Date(startYear, startMonth - 1, startDay, 0, 0, 0)
      const endDateTime = new Date(startYear, startMonth - 1, startDay, 23, 59, 59)
      startDate = startDateTime.toISOString()
      dueDate = endDateTime.toISOString()
        } else {
      // Êó∂Èó¥ÊÆµ‰ªªÂä°
      const [startYear, startMonth, startDay] = quickAddForm.value.startDate.split('-').map(Number)
      const [startHour, startMinute] = quickAddForm.value.startTime.split(':').map(Number)

      const startDateTime = new Date(startYear, startMonth - 1, startDay, startHour, startMinute, 0)
      startDate = startDateTime.toISOString()

      // Ê£ÄÊü•ÊòØÂê¶ÊúâÁªìÊùüÊó•Êúü
      if (quickAddForm.value.endDate && quickAddForm.value.endDate !== quickAddForm.value.startDate) {
        // Ë∑®Â§©Êó∂Èó¥ÊÆµ‰ªªÂä°
        const [endYear, endMonth, endDay] = quickAddForm.value.endDate.split('-').map(Number)
        const [endHour, endMinute] = quickAddForm.value.endTime.split(':').map(Number)

        const endDateTime = new Date(endYear, endMonth - 1, endDay, endHour, endMinute, 0)
        dueDate = endDateTime.toISOString()
      } else {
        // Âêå‰∏ÄÂ§©Êó∂Èó¥ÊÆµ‰ªªÂä°
        const [endHour, endMinute] = quickAddForm.value.endTime.split(':').map(Number)
        const endDateTime = new Date(startYear, startMonth - 1, startDay, endHour, endMinute, 0)
        dueDate = endDateTime.toISOString()
      }
    }

    console.log('Ê∑ªÂä†‰ªªÂä°ÔºåÂºÄÂßãÊó∂Èó¥:', startDate, 'ÁªìÊùüÊó∂Èó¥:', dueDate)

    const taskData = {
      title: quickAddForm.value.title,
      description: quickAddForm.value.description,
      priority_id: priorityMap[quickAddForm.value.priority] || 2,
      start_date: startDate,
      due_date: dueDate
    }

    await todoStore.createTodo(taskData)
    ElMessage.success('‰ªªÂä°Ê∑ªÂä†ÊàêÂäü')
    showQuickAddDialog.value = false

    // ÈáçÊñ∞Ëé∑Âèñ‰ªªÂä°ÂàóË°®‰ª•Êõ¥Êñ∞Êó•ÂéÜÊòæÁ§∫
    await todoStore.fetchTodos()

    // ÈáçÁΩÆË°®Âçï
    quickAddForm.value = {
      title: '',
      startDate: '',
      endDate: '',
      startTime: '09:00',
      endTime: '10:00',
      isAllDay: false,
      priority: 'medium',
      description: '',
      category_id: null
    }
  } catch (error) {
    console.error('Ê∑ªÂä†‰ªªÂä°Â§±Ë¥•:', error)
    ElMessage.error('Ê∑ªÂä†‰ªªÂä°Â§±Ë¥•: ' + (error.response?.data?.message || error.message))
  }
}

const getLunarDate = (date) => {
  // ÁÆÄÂçïÁöÑÂÜúÂéÜËΩ¨Êç¢ÔºåÂÆûÈôÖÈ°πÁõÆ‰∏≠ÂèØ‰ª•‰ΩøÁî®‰∏ìÈó®ÁöÑÂÜúÂéÜÂ∫ì
  const lunarDates = ['Âàù‰∏Ä', 'Âàù‰∫å', 'Âàù‰∏â', 'ÂàùÂõõ', 'Âàù‰∫î', 'ÂàùÂÖ≠', 'Âàù‰∏É', 'ÂàùÂÖ´', 'Âàù‰πù', 'ÂàùÂçÅ',
                     'ÂçÅ‰∏Ä', 'ÂçÅ‰∫å', 'ÂçÅ‰∏â', 'ÂçÅÂõõ', 'ÂçÅ‰∫î', 'ÂçÅÂÖ≠', 'ÂçÅ‰∏É', 'ÂçÅÂÖ´', 'ÂçÅ‰πù', '‰∫åÂçÅ',
                     'Âªø‰∏Ä', 'Âªø‰∫å', 'Âªø‰∏â', 'ÂªøÂõõ', 'Âªø‰∫î', 'ÂªøÂÖ≠', 'Âªø‰∏É', 'ÂªøÂÖ´', 'Âªø‰πù', '‰∏âÂçÅ']
  return lunarDates[date.getDate() % 30]
}

const getEventClass = (event) => {
  // Ê†πÊçÆ‰ºòÂÖàÁ∫ßIDÊàñÂêçÁß∞Á°ÆÂÆöÊ†∑ÂºèÁ±ª
  const priorityId = event.priority_id || event.priorityId
  const priorityName = event.priority

  let priorityClass = 'event-medium'

  if (priorityId) {
    // Ê†πÊçÆ‰ºòÂÖàÁ∫ßID
    if (priorityId === 1) priorityClass = 'event-low'
    else if (priorityId === 2) priorityClass = 'event-medium'
    else if (priorityId === 3) priorityClass = 'event-high'
    else if (priorityId === 4 || priorityId === 5) priorityClass = 'event-urgent'
  } else if (priorityName) {
    // Ê†πÊçÆ‰ºòÂÖàÁ∫ßÂêçÁß∞
    const priorityClasses = {
      'low': 'event-low',
      'medium': 'event-medium',
      'high': 'event-high',
      'urgent': 'event-urgent'
    }
    priorityClass = priorityClasses[priorityName] || 'event-medium'
  }

  // Ê∑ªÂä†Ë∑®Â§©Ê†∑ÂºèÁ±ª
  if (event.isMultiDay) {
    priorityClass += ' multi-day'
    if (event.isFirstDay) {
      priorityClass += ' multi-day-start'
    } else if (event.isLastDay) {
      priorityClass += ' multi-day-end'
    } else if (event.isMiddleDay) {
      priorityClass += ' multi-day-middle'
    }
  }

  return priorityClass
}

const getEventsForDate = (date) => {
  const dateStr = getLocalDateString(date)
  const todos = todoStore.todos || []
  return todos.filter(todo => {
    // ÂÖºÂÆπ‰∏çÂêåÁöÑÂ≠óÊÆµÂêçÁß∞
    const startDate = todo.startDate || todo.start_date ? new Date(todo.startDate || todo.start_date) : null
    const dueDate = todo.dueDate || todo.due_date ? new Date(todo.dueDate || todo.due_date) : null

    if (startDate && dueDate) {
      const startDateStr = getLocalDateString(startDate)
      const dueDateStr = getLocalDateString(dueDate)
      return dateStr >= startDateStr && dateStr <= dueDateStr
    } else if (startDate) {
      return dateStr === getLocalDateString(startDate)
    } else if (dueDate) {
      return dateStr === getLocalDateString(dueDate)
    }
    return false
  }).map(todo => {
    // ‰∏∫ÊØè‰∏™‰ªªÂä°Ê∑ªÂä†Ë∑®Â§©‰ø°ÊÅØ
    const startDate = todo.startDate || todo.start_date ? new Date(todo.startDate || todo.start_date) : null
    const dueDate = todo.dueDate || todo.due_date ? new Date(todo.dueDate || todo.due_date) : null

    if (startDate && dueDate) {
      const startDateStr = getLocalDateString(startDate)
      const dueDateStr = getLocalDateString(dueDate)
      const currentDateStr = getLocalDateString(date)

      return {
        ...todo,
        isMultiDay: startDateStr !== dueDateStr,
        isFirstDay: currentDateStr === startDateStr,
        isLastDay: currentDateStr === dueDateStr,
        isMiddleDay: currentDateStr > startDateStr && currentDateStr < dueDateStr
      }
    }

    return {
      ...todo,
      isMultiDay: false,
      isFirstDay: true,
      isLastDay: true,
      isMiddleDay: false
    }
  })
}

const formatEventTime = (event) => {
  const start = event.startDate || event.start_date ? new Date(event.startDate || event.start_date) : null
  const end = event.dueDate || event.due_date ? new Date(event.dueDate || event.due_date) : null

  if (start && end) {
    return `${start.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })} - ${end.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}`
  } else if (start) {
    return start.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
  }
  return 'ÂÖ®Â§©'
}

const getPriorityType = (priority) => {
  const typeMap = { 1: 'success', 2: 'warning', 3: 'danger', 4: 'danger', 5: 'danger' }
  return typeMap[priority] || 'info'
}

const getPriorityText = (priority) => {
  const textMap = { 1: '‰Ωé', 2: '‰∏≠', 3: 'È´ò', 4: 'Á¥ßÊÄ•', 5: 'Á´ãÂç≥' }
  return textMap[priority] || 'Êú™Áü•'
}

const getStatusType = (status) => {
  const typeMap = {
    'pending': 'info',
    'in_progress': 'warning',
    'completed': 'success',
    'cancelled': 'danger'
  }
  return typeMap[status] || 'info'
}

const getStatusText = (status) => {
  const textMap = {
    'pending': 'ÂæÖÂ§ÑÁêÜ',
    'in_progress': 'ËøõË°å‰∏≠',
    'completed': 'Â∑≤ÂÆåÊàê',
    'cancelled': 'Â∑≤ÂèñÊ∂à'
  }
  return textMap[status] || 'Êú™Áü•'
}



// ÁîüÂëΩÂë®Êúü
onMounted(async () => {
  await todoStore.fetchTodos()
  await todoStore.fetchCategories()
})
</script>

<style scoped>
.calendar-page {
  padding: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
}

/* ÁÇ´ÈÖ∑Â§¥ÈÉ® */
.calendar-header {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  padding: 30px;
  margin-bottom: 30px;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-left {
  flex: 1;
}

.header-title {
  font-size: 2.5rem;
  font-weight: 700;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin: 0 0 10px 0;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.header-subtitle {
  font-size: 1.1rem;
  color: #666;
  margin: 0;
  font-weight: 400;
}

.header-actions {
  display: flex;
  gap: 15px;
}

/* Â§ßÊó•ÂéÜ‰∏ª‰Ωì */
.calendar-main {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

/* Êó•ÂéÜÂØºËà™Ê†è */
.calendar-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 2px solid rgba(102, 126, 234, 0.1);
}

.nav-left {
  display: flex;
  align-items: center;
  gap: 15px;
}

.nav-center {
  flex: 1;
  text-align: center;
}

.current-month {
  font-size: 2rem;
  font-weight: 700;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin: 0;
}

.nav-right {
  display: flex;
  align-items: center;
  gap: 15px;
}

/* Â§ßÊó•ÂéÜË°®Ê†º */
.calendar-grid {
  background: white;
  border-radius: 15px;
  overflow: visible;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  padding: 10px;
}

/* ÊòüÊúüÊ†áÈ¢ò */
.calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.weekday-header {
  padding: 20px 10px;
  text-align: center;
  font-weight: 600;
  font-size: 1.1rem;
  border-right: 1px solid rgba(255, 255, 255, 0.1);
  transition: all 0.3s ease;
}

.weekday-header.weekend {
  background: rgba(255, 255, 255, 0.1);
}

.weekday-header:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: translateY(-2px);
}

/* Êó•ÊúüÁΩëÊ†º */
.calendar-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  background: white;
}

.calendar-day {
  min-height: 120px;
  padding: 15px 10px 15px 10px;
  border-right: 1px solid #f0f0f0;
  border-bottom: 1px solid #f0f0f0;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  background: white;
  overflow: visible;
}

.calendar-day:hover {
  background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
  z-index: 10;
}

.calendar-day.other-month {
  background: #fafafa;
  color: #ccc;
}

.calendar-day.today {
  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
  color: white;
  font-weight: 700;
  box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
  border: 3px solid #fff;
  transform: scale(1.05);
  z-index: 20;
  position: relative;
}

.calendar-day.today::before {
  content: '‰ªäÂ§©';
  position: absolute;
  top: -8px;
  right: 2px;
  background: #ff6b6b;
  color: white;
  font-size: 0.7rem;
  padding: 2px 6px;
  border-radius: 10px;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  z-index: 30;
}

.calendar-day.selected {
  background: linear-gradient(135deg, #409eff 0%, #36a3f7 100%);
  color: white;
  font-weight: 700;
  box-shadow: 0 5px 15px rgba(64, 158, 255, 0.3);
}

.calendar-day.weekend {
  background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%);
}

.calendar-day.weekend:hover {
  background: linear-gradient(135deg, #ffe8e8 0%, #ffd6d6 100%);
}

.calendar-day.has-events {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
}

.calendar-day.has-events:hover {
  background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
}

/* Êó•ÊúüÊï∞Â≠ó */
.day-number {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 10px;
}

.date-number {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 2px;
}

.lunar-date {
  font-size: 0.7rem;
  color: #999;
  opacity: 0.8;
}

.calendar-day.today .lunar-date,
.calendar-day.selected .lunar-date {
  color: rgba(255, 255, 255, 0.8);
}

/* ‰∫ã‰ª∂ÂàóË°® */
.day-events {
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.day-event {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.7rem;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.day-event:hover {
  transform: scale(1.05);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.event-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}

.event-title {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* ‰∫ã‰ª∂‰ºòÂÖàÁ∫ßÊ†∑Âºè */
.event-urgent {
  background: rgba(245, 108, 108, 0.2);
  color: #f56c6c;
  border: 1px solid rgba(245, 108, 108, 0.3);
}

.event-urgent .event-dot {
  background: #f56c6c;
}

.event-high {
  background: rgba(230, 162, 60, 0.2);
  color: #e6a23c;
  border: 1px solid rgba(230, 162, 60, 0.3);
}

.event-high .event-dot {
  background: #e6a23c;
}

.event-medium {
  background: rgba(64, 158, 255, 0.2);
  color: #409eff;
  border: 1px solid rgba(64, 158, 255, 0.3);
}

.event-medium .event-dot {
  background: #409eff;
}

.event-low {
  background: rgba(103, 194, 58, 0.2);
  color: #67c23a;
  border: 1px solid rgba(103, 194, 58, 0.3);
}

.event-low .event-dot {
  background: #67c23a;
}

/* Ë∑®Â§©‰ªªÂä°ËøûÊé•Ê†∑Âºè */
.multi-day {
  position: relative;
  margin: 0 -2px;
  z-index: 2;
}

.multi-day-start {
  border-top-left-radius: 8px;
  border-bottom-left-radius: 8px;
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
  margin-right: 0;
  position: relative;
}

.multi-day-start::after {
  content: '';
  position: absolute;
  top: 0;
  right: -2px;
  width: 4px;
  height: 100%;
  background: inherit;
  border-top-right-radius: 4px;
  border-bottom-right-radius: 4px;
}

.multi-day-middle {
  border-radius: 0;
  margin: 0 -2px;
  position: relative;
}

.multi-day-middle::before {
  content: '';
  position: absolute;
  top: 0;
  left: -2px;
  width: 4px;
  height: 100%;
  background: inherit;
  border-top-left-radius: 4px;
  border-bottom-left-radius: 4px;
}

.multi-day-middle::after {
  content: '';
  position: absolute;
  top: 0;
  right: -2px;
  width: 4px;
  height: 100%;
  background: inherit;
  border-top-right-radius: 4px;
  border-bottom-right-radius: 4px;
}

.multi-day-end {
  border-top-right-radius: 8px;
  border-bottom-right-radius: 8px;
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
  margin-left: 0;
  position: relative;
}

.multi-day-end::before {
  content: '';
  position: absolute;
  top: 0;
  left: -2px;
  width: 4px;
  height: 100%;
  background: inherit;
  border-top-left-radius: 4px;
  border-bottom-left-radius: 4px;
}

/* Êó∂Èó¥È¢ÑËÆæÊ†∑Âºè */
.time-range {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.time-separator {
  color: #666;
  font-weight: 500;
}

.time-presets {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 10px;
}

.time-presets .el-button {
  font-size: 0.8rem;
  padding: 4px 8px;
  border-radius: 6px;
}

/* Êó•ÊúüÊó∂Èó¥ÁªÑÂêàÊ†∑Âºè */
.datetime-group {
  display: flex;
  gap: 10px;
  align-items: center;
}

.datetime-group .el-date-picker {
  flex: 1;
}

.datetime-group .el-time-picker {
  flex: 1;
}

/* Ë∑®Â§©‰ªªÂä°ËøûÊé•ÊåáÁ§∫Âô® */
.event-continue-indicator {
  position: absolute;
  right: -8px;
  top: 50%;
  transform: translateY(-50%);
  width: 16px;
  height: 16px;
  background: inherit;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: inherit;
  font-size: 8px;
  z-index: 3;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.event-continue-indicator::before {
  content: '';
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  width: 8px;
  height: 2px;
  background: inherit;
  border-radius: 1px;
}

/* Â¢ûÂº∫Ë∑®Â§©‰ªªÂä°ÁöÑËßÜËßâÊïàÊûú */
.multi-day {
  position: relative;
  margin: 0 -1px;
  z-index: 2;
  border-radius: 6px;
}

.multi-day-start {
  border-top-left-radius: 8px;
  border-bottom-left-radius: 8px;
  border-top-right-radius: 4px;
  border-bottom-right-radius: 4px;
  margin-right: 0;
  position: relative;
}

.multi-day-start::after {
  content: '';
  position: absolute;
  top: 0;
  right: -1px;
  width: 2px;
  height: 100%;
  background: inherit;
  border-top-right-radius: 1px;
  border-bottom-right-radius: 1px;
}

.multi-day-middle {
  border-radius: 0;
  margin: 0 -1px;
  position: relative;
}

.multi-day-middle::before {
  content: '';
  position: absolute;
  top: 0;
  left: -1px;
  width: 2px;
  height: 100%;
  background: inherit;
  border-top-left-radius: 1px;
  border-bottom-left-radius: 1px;
}

.multi-day-middle::after {
  content: '';
  position: absolute;
  top: 0;
  right: -1px;
  width: 2px;
  height: 100%;
  background: inherit;
  border-top-right-radius: 1px;
  border-bottom-right-radius: 1px;
}

.multi-day-end {
  border-top-right-radius: 8px;
  border-bottom-right-radius: 8px;
  border-top-left-radius: 4px;
  border-bottom-left-radius: 4px;
  margin-left: 0;
  position: relative;
}

.multi-day-end::before {
  content: '';
  position: absolute;
  top: 0;
  left: -1px;
  width: 2px;
  height: 100%;
  background: inherit;
  border-top-left-radius: 1px;
  border-bottom-left-radius: 1px;
}

/* Êõ¥Â§ö‰∫ã‰ª∂ÊåáÁ§∫Âô® */
.more-events {
  font-size: 0.6rem;
  color: #999;
  text-align: center;
  padding: 2px;
  cursor: pointer;
  border-radius: 3px;
  transition: all 0.2s ease;
}

.more-events:hover {
  background: rgba(102, 126, 234, 0.1);
  color: #667eea;
}

/* Ê∑ªÂä†ÊåâÈíÆ */
.day-add-btn {
  position: absolute;
  top: 5px;
  right: 5px;
  width: 20px;
  height: 20px;
  background: rgba(102, 126, 234, 0.1);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  opacity: 0;
  transition: all 0.3s ease;
  color: #667eea;
}

.calendar-day:hover .day-add-btn {
  opacity: 1;
  transform: scale(1.1);
}

.day-add-btn:hover {
  background: rgba(102, 126, 234, 0.2);
  transform: scale(1.2);
}

/* ÂØπËØùÊ°ÜÊ†∑Âºè */
.el-dialog {
  border-radius: 15px;
  overflow: hidden;
}

.el-dialog__header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px 30px;
}

.el-dialog__title {
  color: white;
  font-weight: 600;
}

.el-dialog__body {
  padding: 30px;
}

.el-dialog__footer {
  padding: 20px 30px;
  border-top: 1px solid #f0f0f0;
}

/* ‰∫ã‰ª∂ËØ¶ÊÉÖÊ†∑Âºè */
.event-detail {
  padding: 20px;
}

.event-detail h3 {
  margin: 0 0 15px 0;
  color: #333;
  font-size: 1.5rem;
}

.event-description {
  color: #666;
  line-height: 1.6;
  margin-bottom: 20px;
}

.event-meta {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .calendar-page {
    padding: 10px;
  }

  .calendar-header {
    padding: 20px;
  }

  .header-title {
    font-size: 1.8rem;
  }

  .calendar-main {
    padding: 20px;
  }

  .current-month {
    font-size: 1.5rem;
  }

  .calendar-day {
    min-height: 80px;
    padding: 10px 5px;
  }

  .date-number {
    font-size: 1rem;
  }

  .day-event {
    font-size: 0.6rem;
    padding: 1px 4px;
  }
}

/* Âä®ÁîªÊïàÊûú */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.calendar-main {
  animation: fadeInUp 0.6s ease-out;
}

.calendar-day {
  animation: fadeInUp 0.3s ease-out;
}

/* ÊªöÂä®Êù°Ê†∑Âºè */
.calendar-days::-webkit-scrollbar {
  width: 6px;
}

.calendar-days::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.calendar-days::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 3px;
}

.calendar-days::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
}

/* Âë®ËßÜÂõæÊ†∑Âºè */
.week-view {
  background: white;
  border-radius: 15px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

.week-header {
  display: grid;
  grid-template-columns: 80px repeat(7, 1fr);
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.week-day-header {
  padding: 15px 10px;
  text-align: center;
  border-right: 1px solid rgba(255, 255, 255, 0.1);
  cursor: pointer;
  transition: all 0.3s ease;
}

.week-day-header:hover {
  background: rgba(255, 255, 255, 0.1);
}

.week-day-header.weekend {
  background: rgba(255, 255, 255, 0.1);
}

.week-day-header.today {
  background: rgba(255, 107, 107, 0.3);
  font-weight: 700;
}

.week-day-header.selected {
  background: rgba(64, 158, 255, 0.3);
  font-weight: 700;
}

.week-day-name {
  font-size: 0.9rem;
  margin-bottom: 5px;
}

.week-day-number {
  font-size: 1.2rem;
  font-weight: 600;
}

.week-content {
  display: grid;
  grid-template-columns: 80px repeat(7, 1fr);
  height: 600px;
  overflow-y: auto;
}

.time-column {
  background: #f8f9fa;
  border-right: 1px solid #e9ecef;
}

.time-slot {
  height: 60px;
  padding: 5px;
  border-bottom: 1px solid #e9ecef;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  color: #666;
  position: relative;
}

.week-day-column {
  border-right: 1px solid #e9ecef;
  position: relative;
}

.week-day-column.weekend {
  background: rgba(255, 245, 245, 0.3);
}

.week-day-column.today {
  background: rgba(255, 107, 107, 0.1);
}

.week-day-column.selected {
  background: rgba(64, 158, 255, 0.1);
}

.week-day-column .time-slot {
  cursor: pointer;
  transition: all 0.2s ease;
}

.week-day-column .time-slot:hover {
  background: rgba(102, 126, 234, 0.1);
}

.week-event {
  background: rgba(64, 158, 255, 0.2);
  color: #409eff;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.7rem;
  margin: 1px 0;
  cursor: pointer;
  border: 1px solid rgba(64, 158, 255, 0.3);
  transition: all 0.2s ease;
}

.week-event:hover {
  background: rgba(64, 158, 255, 0.3);
  transform: scale(1.02);
}

/* Êó•ËßÜÂõæÊ†∑Âºè */
.day-view {
  background: white;
  border-radius: 15px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

.day-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  text-align: center;
}

.day-header h3 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
}

.day-timeline {
  height: 600px;
  overflow-y: auto;
}

.day-timeline .time-slot {
  display: flex;
  border-bottom: 1px solid #e9ecef;
  min-height: 80px;
  transition: all 0.2s ease;
}

.day-timeline .time-slot:hover {
  background: rgba(102, 126, 234, 0.05);
}

.day-timeline .time-slot.current-hour {
  background: rgba(255, 107, 107, 0.1);
  border-left: 4px solid #ff6b6b;
}

.time-label {
  width: 80px;
  padding: 10px;
  background: #f8f9fa;
  border-right: 1px solid #e9ecef;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  color: #666;
  font-size: 0.9rem;
}

.time-content {
  flex: 1;
  padding: 10px;
  position: relative;
}

.day-event {
  background: rgba(64, 158, 255, 0.1);
  border: 1px solid rgba(64, 158, 255, 0.3);
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.day-event:hover {
  background: rgba(64, 158, 255, 0.2);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.day-event .event-time {
  font-size: 0.8rem;
  color: #666;
  margin-bottom: 5px;
}

.day-event .event-title {
  font-weight: 600;
  color: #333;
  margin-bottom: 5px;
}

.day-event .event-description {
  font-size: 0.8rem;
  color: #666;
  line-height: 1.4;
}

.add-event-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 30px;
  height: 30px;
  background: rgba(102, 126, 234, 0.1);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  opacity: 0;
  transition: all 0.3s ease;
  color: #667eea;
}

.time-content:hover .add-event-btn {
  opacity: 1;
}

.add-event-btn:hover {
  background: rgba(102, 126, 234, 0.2);
  transform: scale(1.1);
}

/* Âë®ÊúüTODOÁöÑÊ∑±Ëâ≤ÊòæÁ§∫ */
.event-urgent {
  background: rgba(245, 108, 108, 0.3) !important;
  color: #f56c6c !important;
  border: 1px solid rgba(245, 108, 108, 0.5) !important;
}

.event-high {
  background: rgba(230, 162, 60, 0.3) !important;
  color: #e6a23c !important;
  border: 1px solid rgba(230, 162, 60, 0.5) !important;
}

.event-medium {
  background: rgba(64, 158, 255, 0.3) !important;
  color: #409eff !important;
  border: 1px solid rgba(64, 158, 255, 0.5) !important;
}

.event-low {
  background: rgba(103, 194, 58, 0.3) !important;
  color: #67c23a !important;
  border: 1px solid rgba(103, 194, 58, 0.5) !important;
}
</style>
